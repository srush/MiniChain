
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mini-Chain">
      
      
        <meta name="author" content="Sasha Rush">
      
      
        <link rel="canonical" href="https://srush.github.io/minichain/">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.1.3">
    
    
      
        <title>Mini-Chain</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.edf004c2.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="assets/css-js/termynal/css/termynal.css">
    
      <link rel="stylesheet" href="assets/css-js/termynal/css/custom.css">
    
      <link rel="stylesheet" href="assets/css-js/general/css/progressbar.css">
    
      <link rel="stylesheet" href="assets/css-js/mkdocs-tooltips/css/hint.min.css">
    
      <link rel="stylesheet" href="assets/css-js/mkdocs-tooltips/css/custom.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
    
      <link rel="stylesheet" href="assets/css-js/fastapi/custom.css">
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mini-chain" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Mini-Chain" class="md-header__button md-logo" aria-label="Mini-Chain" data-md-component="logo">
      
  <img src="https://user-images.githubusercontent.com/35882/218286642-67985b6f-d483-49be-825b-f62b72c469cd.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mini-Chain
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/srush/minichain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="." class="md-tabs__link md-tabs__link--active">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="examples/bash/" class="md-tabs__link">
        Examples
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Mini-Chain" class="md-nav__button md-logo" aria-label="Mini-Chain" data-md-component="logo">
      
  <img src="https://user-images.githubusercontent.com/35882/218286642-67985b6f-d483-49be-825b-f62b72c469cd.png" alt="logo">

    </a>
    Mini-Chain
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/srush/minichain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Home
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-mini-chain" class="md-nav__link">
    Why Mini-Chain?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial" class="md-nav__link">
    Tutorial
  </a>
  
    <nav class="md-nav" aria-label="Tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documents-and-embeddings" class="md-nav__link">
    Documents and Embeddings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-calls" class="md-nav__link">
    Asynchronous Calls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing" class="md-nav__link">
    Parsing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/bash/" class="md-nav__link">
        Bash
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/math/" class="md-nav__link">
        Math
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/pal/" class="md-nav__link">
        Pal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/selfask/" class="md-nav__link">
        Selfask
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/ner/" class="md-nav__link">
        Ner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/summary/" class="md-nav__link">
        Summary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/qa/" class="md-nav__link">
        Qa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="examples/gatsby/" class="md-nav__link">
        Gatsby
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-mini-chain" class="md-nav__link">
    Why Mini-Chain?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial" class="md-nav__link">
    Tutorial
  </a>
  
    <nav class="md-nav" aria-label="Tutorial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documents-and-embeddings" class="md-nav__link">
    Documents and Embeddings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-calls" class="md-nav__link">
    Asynchronous Calls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing" class="md-nav__link">
    Parsing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

                

<h1 id="mini-chain">Mini-Chain<a class="headerlink" href="#mini-chain" title="Permanent link">&para;</a></h1>
<p>A tiny library for <strong>large</strong> language models.</p>
<p>[<a href="https://srush.github.io/MiniChain">Documentation and Examples</a>]</p>
<p><center><img width="200px" src="https://user-images.githubusercontent.com/35882/218286642-67985b6f-d483-49be-825b-f62b72c469cd.png"/></center></p>
<p>Write apps that can easily and efficiently call multiple language models.</p>
<ul>
<li>Code (<a href="https://github.com/srush/MiniChain/blob/main/examples/math.py">math.py</a>):</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># A prompt from the Jinja template below.</span>
<span class="k">class</span> <span class="nc">MathPrompt</span><span class="p">(</span><span class="n">TemplatePrompt</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">template_file</span> <span class="o">=</span> <span class="s2">&quot;math.pmpt.tpl&quot;</span>

<span class="k">with</span> <span class="n">start_chain</span><span class="p">(</span><span class="s2">&quot;math&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
    <span class="c1"># MathPrompt with OpenAI backend</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">MathPrompt</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">())</span>
    <span class="c1"># A prompt that simply runs Python</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">SimplePrompt</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">Python</span><span class="p">())</span>
    <span class="c1"># Chain them together</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
    <span class="c1"># Call chain with a question.</span>
    <span class="n">question</span> <span class="o">=</span><span class="s2">&quot;&#39;What is the sum of the powers of 3 (3^i) that are smaller than 100?&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prompt</span><span class="p">({</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">question</span><span class="p">}))</span>
</code></pre></div>
<ul>
<li>Template (<a href="https://github.com/srush/MiniChain/blob/main/examples/math.pmpt.tpl">math.pmpt.tpl</a>):</li>
</ul>
<div class="highlight"><pre><span></span><code>...
Question:
A robe takes 2 bolts of blue fiber and half that much white fiber. How many bolts in total does it take?
Code:
2 + 2/2

Question:
{{question}}
Code:
</code></pre></div>
<ul>
<li>Install and Execute:</li>
</ul>
<div class="highlight"><pre><span></span><code>&gt; pip install git+https://github.com/srush/MiniChain/
&gt; <span class="nb">export</span> <span class="nv">OPENAI_KEY</span><span class="o">=</span><span class="s2">&quot;sk-***&quot;</span>
&gt; python math.py
</code></pre></div>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<p>This library allows us to implement several popular approaches in a few lines of code.</p>
<ul>
<li><a href="https://srush.github.io/MiniChain/examples/qa/">Retrieval-Augmented QA</a></li>
<li><a href="https://srush.github.io/MiniChain/examples/pal/">PAL</a> - <a href="https://arxiv.org/pdf/2211.10435.pdf">(Gao et al 2023)</a></li>
<li><a href="https://srush.github.io/MiniChain/examples/selfask/">Self-Ask</a> - <a href="https://ofir.io/self-ask.pdf">(Press et al 2022)</a></li>
<li><a href="https://srush.github.io/MiniChain/examples/bash/">Chain-of-Thought</a> - <a href="https://arxiv.org/abs/2201.11903">(Wei et al 2022)</a></li>
</ul>
<p>It supports the current backends.</p>
<ul>
<li>OpenAI (Completions / Embeddings)</li>
<li>Hugging Face ðŸ¤—</li>
<li>Google Search</li>
<li>Python</li>
<li>Manifest-ML (AI21, Cohere, Together)</li>
<li>Bash</li>
</ul>
<h2 id="why-mini-chain">Why Mini-Chain?<a class="headerlink" href="#why-mini-chain" title="Permanent link">&para;</a></h2>
<p>There are several very popular libraries for prompt chaining,
notably: <a href="https://langchain.readthedocs.io/en/latest/">LangChain</a>,
<a href="https://github.com/promptslab/Promptify">Promptify</a>, and
<a href="https://gpt-index.readthedocs.io/en/latest/reference/prompts.html">GPTIndex</a>.
These library are useful, but they are extremely large and
complex. MiniChain aims to implement the core prompt chaining
functionality in a tiny digestable library.</p>
<h2 id="tutorial">Tutorial<a class="headerlink" href="#tutorial" title="Permanent link">&para;</a></h2>
<p>Mini-chain is based on Prompts.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/35882/221280012-d58c186d-4da2-4cb6-96af-4c4d9069943f.png" /></p>
<p>You can write your own prompts by overriding the <code>prompt</code> and <code>parse</code>
function on the <code>Prompt[Input, Output]</code> class.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ColorPrompt</span><span class="p">(</span><span class="n">Prompt</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]):</span>
    <span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Encode prompting logic&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Answer &#39;Yes&#39; if this is a color, </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2">. Answer:&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">out</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Encode the parsing logic</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span>
</code></pre></div>
<p>The LLM for the Prompt is specified by the backend. To run a prompt, we give a backend and then call it like a function. To access backends, you need to call <code>start_chain</code>
which also manages logging.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">start_chain</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
    <span class="n">prompt1</span> <span class="o">=</span> <span class="n">ColorPrompt</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">prompt1</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s a color!&quot;</span><span class="p">)</span>
</code></pre></div>
<p>You can write a standard Python program just by calling these prompts. Alternatively you can chain prompts together.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/35882/221281771-3770be96-02ce-4866-a6f8-c458c9a11c6f.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">start_chain</span><span class="p">(</span><span class="s2">&quot;mychain&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
    <span class="n">prompt0</span> <span class="o">=</span> <span class="n">SimplePrompt</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">())</span>
    <span class="n">chained_prompt</span> <span class="o">=</span> <span class="n">prompt0</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">prompt1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chained_prompt</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">):</span>
        <span class="o">...</span>
</code></pre></div>
<p>Prompt <code>SimplePrompt</code> simply passes its input string to the
language-model and returns its output string.</p>
<p>We also include <code>TemplatePrompt[Output]</code> which assumes <code>parse</code> uses template from the
<a href="https://jinja.palletsprojects.com/en/3.1.x/templates/">Jinja</a> language.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MathPrompt</span><span class="p">(</span><span class="n">TemplatePrompt</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">template_file</span> <span class="o">=</span> <span class="s2">&quot;math.pmpt.tpl&quot;</span>
</code></pre></div>
<p>Logging is done automatically based on the name of your chain using the <a href="https://eliot.readthedocs.io/en/stable/">eliot</a> logging framework.
You can run the following command to get the full output of your
system.</p>
<div class="highlight"><pre><span></span><code><span class="n">show_log</span><span class="p">(</span><span class="s2">&quot;mychain.log&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="documents-and-embeddings">Documents and Embeddings<a class="headerlink" href="#documents-and-embeddings" title="Permanent link">&para;</a></h3>
<p>MiniChain is agnostic to how you manage documents and embeddings. We recommend using
the <a href="https://huggingface.co/docs/datasets/index">Hugging Face Datasets</a> library with
built in FAISS indexing.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/35882/221387303-e3dd8456-a0f0-4a70-a1bb-657fe2240862.png" /></p>
<p>Here is the implementation.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Load and index a dataset</span>
<span class="n">olympics</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="s2">&quot;olympics.data&quot;</span><span class="p">)</span>
<span class="n">olympics</span><span class="o">.</span><span class="n">add_faiss_index</span><span class="p">(</span><span class="s2">&quot;embeddings&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">KNNPrompt</span><span class="p">(</span><span class="n">EmbeddingPrompt</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">olympics</span><span class="o">.</span><span class="n">get_nearest_examples</span><span class="p">(</span><span class="s2">&quot;embeddings&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<p>This creates a K-nearest neighbors (KNN) <code>Prompt</code> that looks up the
3 closest documents based on embeddings of the question asked.
See the full <a href="https://srush.github.io/MiniChain/examples/qa/">Retrieval-Augemented QA</a>
example.</p>
<p>We recommend creating these embeddings offline using the batch map functionality of the
datasets library.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">emb</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">Embedding</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="n">EMBEDDING_MODEL</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;embeddings&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emb</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;embedding&#39;</span><span class="p">])</span>
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emb</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]))]}</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">embed</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="s2">&quot;olympics.data&quot;</span><span class="p">)</span>
</code></pre></div>
<p>There are other ways to do this such as <a href="https://github.com/asg017/sqlite-vss">sqllite</a>
or <a href="https://weaviate.io/">Weaviate</a>.</p>
<h2 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="asynchronous-calls">Asynchronous Calls<a class="headerlink" href="#asynchronous-calls" title="Permanent link">&para;</a></h3>
<p>Prompt chains make it easier to manage asynchronous execution. Prompt has a method <code>arun</code> which will
make the language model call asynchronous.
Async calls need the <a href="https://trio.readthedocs.io/en/stable/">trio</a> library.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">trio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">fn1</span><span class="p">(</span><span class="n">prompt1</span><span class="p">):</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">prompt1</span><span class="o">.</span><span class="n">arun</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">):</span>
        <span class="o">...</span>

<span class="n">trio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">prompt1</span><span class="p">)</span>
</code></pre></div>
<p>A convenient construct is the <code>map</code> function which runs a prompt on a list of inputs.</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/35882/221283494-6f76ee85-3652-4bb3-bc42-4e961acd1477.png" /></p>
<p>This code runs a summarization prompt with asynchonous calls to the API.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">start_chain</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
    <span class="n">list_prompt</span> <span class="o">=</span> <span class="n">SummaryPrompt</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">())</span><span class="o">.</span><span class="n">map</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">list_prompt</span><span class="o">.</span><span class="n">arun</span><span class="p">,</span> <span class="n">documents</span><span class="p">)</span>
</code></pre></div>
<h3 id="parsing">Parsing<a class="headerlink" href="#parsing" title="Permanent link">&para;</a></h3>
<p>Minichain lets you use whatever parser you would like.
One example is <a href="https://parsita.drhagen.com/">parsita</a> a
cool parser combinator library. This example builds a little
state machine based on the LLM response with error handling.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SelfAsk</span><span class="p">(</span><span class="n">TemplatePrompt</span><span class="p">[</span><span class="n">IntermediateState</span> <span class="o">|</span> <span class="n">FinalState</span><span class="p">]):</span>
    <span class="n">template_file</span> <span class="o">=</span> <span class="s2">&quot;selfask.pmpt.tpl&quot;</span>

    <span class="k">class</span> <span class="nc">Parser</span><span class="p">(</span><span class="n">TextParsers</span><span class="p">):</span>
        <span class="n">follow</span> <span class="o">=</span> <span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Follow up:&quot;</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">reg</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">IntermediateState</span>
        <span class="n">finish</span> <span class="o">=</span> <span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;So the final answer is: &quot;</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">reg</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">FinalState</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">follow</span> <span class="o">|</span> <span class="n">finish</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Parser</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">or_die</span><span class="p">()</span>
</code></pre></div>
<p>[<a href="https://srush.github.io/MiniChain">Full Examples</a>]</p>

              

<style>
// Do whatever changes you need here

.jp-RenderedHTMLCommon p {
    color: red;
}

.jupyter-wrapper .jp-OutputArea-output pre {
    font-size: 15px;
    padding: 15px;

}
.jupyter-wrapper .jp-CodeCell .jp-Cell-inputWrapper .jp-InputPrompt {
   display: none;
}
.jupyter-wrapper .jp-CodeCell .jp-Cell-outputWrapper .jp-OutputPrompt {
   display: none;
}

.jupyter-wrapper .celltag_hide {
   display: none;
}

.jupyter-wrapper .celltag_hide_inp .jp-InputArea {
   display: none;
}

.jupyter-wrapper .jp-OutputArea-output dt {
    width: 100%;
}
.jupyter-wrapper .jp-OutputArea-output dd {
    width: 100%;
    margin-left: 20px;
}

.jupyter-wrapper .jp-OutputArea-output.jp-RenderedSVG {
    text-align: center;
    padding-top: 10px;
}

</style>

            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
      
        
        <a href="examples/bash/" class="md-footer__link md-footer__link--next" aria-label="Next: Bash" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Bash
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Maintained by <a href="https://github.com/srush">Sasha Rush</a>.

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": ["content.code.annotate", "content.tabs.link", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", {"toc.integrate": false}], "search": "assets/javascripts/workers/search.0bbba5b5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.e1a181d9.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="assets/css-js/general/js/tables.js"></script>
      
        <script src="assets/css-js/termynal/js/termynal.js"></script>
      
        <script src="assets/css-js/termynal/js/custom.js"></script>
      
        <script src="."></script>
      
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
      
        <script src="assets/css-js/general/js/highlight-config.js"></script>
      
        <script src="https://unpkg.com/d3@6.7.0/dist/d3.min.js"></script>
      
        <script src="https://unpkg.com/markmap-lib@0.11.5/dist/browser/index.min.js"></script>
      
        <script src="https://unpkg.com/markmap-view@0.2.6/dist/index.min.j"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="assets/css-js/fastapi/custom.js"></script>
      
        <script src="assets/css-js/fastapi/chat.js"></script>
      
    
  </body>
</html>